# Contribute

There are many ways to contribute to lash:
- report bugs
- get involved into the language design discussions
- clone the repo and start coding

This guide focuses on how to get started with the development. If you want to report bugs or ideas please create an issue on the [issues page](https://github.com/crainsaw/lash/issues).


# Prerequisites

In order to be able to get involved into the  development you will need the following software to be installed on your computer:
- [nodejs](https://nodejs.org/en/) + npm (or [yarn](https://yarnpkg.com/))
- [Typescript](https://www.npmjs.com/package/typescript)
- [Visual Studio Code](https://code.visualstudio.com/)
- Visual Studio Code Extensions:
    - [ANTLR4 grammar syntax support](https://marketplace.visualstudio.com/items?itemName=mike-lischke.vscode-antlr4)
    - [ESLint](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint)
    - [Prettier - Code formatter](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode)
    - [Jest](https://marketplace.visualstudio.com/items?itemName=Orta.vscode-jest) (optional)
- [Java runtime](https://www.java.com/de/download/) (needed for the ANTLRv4 compiler)


# Installation

## Clone and install
```bash
git clone https://github.com/crainsaw/lash.git
npm install
```

## Build
Lash uses npm scripts to perform all necessary tasks related to the development process. When you open the project for the first time run `npm run build`. This will run all necessary build tasks. After that run `npm run test` which runs the tests to make sure everything works as expected.

# Introduction
This section describes the high-level structure of the lash compiler.

# Structure
Lash makes use of ANTLRv4 to generate a Lexer and a Parser based on the grammar file defined in `src/grammar/lash.g4`. When running `npm run compile-grammar` ANTRLv4 generates TypeScript code based on this grammar into the folder `antlr_ts_build/`. The generated code is then used by the lash compiler which is located in `scr/`. Lash itself performs several steps in the following order when compiling a lash input file:
* run the Lexer and Parser (generated by ANTLRv4) which results in a ParseTree
* the visitor `src/grammar/antlrVisitor.ts` visits all nodes in this ParseTree and generates an AST (which is much easier to process then the ParseTree generated by the ANTLR code)
* the type inferencer `src/grammar/typeInferencer.ts` visits this AST to infer the types of all expressions, functions and variables and performs some other checks (e.g. make sure variables are defined before usage or not defined twice)
* the code generator `src/emitter/bash.ts` uses the AST and the result of the TypeInferencer to visit all nodes in the AST and create the desired bash output code

All these steps are bundled into a convenient API in `src/compiler.ts`. This compiler is exposed to the command line via `src/cli.ts`. These both files `src/compiler.ts` and `src/cli.ts` can be considered the main entry points into the lash compiler.

## Folder Structre
The folder structure at a glance:
- `src/` contains the lash compiler
- `antlr_ts_build/` contains the generated Lexer and Parser from ANTLR
- `dist/` contains the final generated Javascript code ready for shipping

### Development
Now you are ready to get started. During development with Visual Studio Code you will use one of the launch configurations (defined in `.vscode/launch.json`) for development:
- `launch lash compiler`
- `build all`
- `debug grammar`

When using `launch lash compiler` as the run configuration the TypeScript code in `src/` will be build and the cli `dist/cli.js` will be run with the currently opened file in Visual Studio Code as the input. This will print the generated bash code to the console. This is the main launch configuration used during development.

When you want to make changes to the lash grammar `src/grammar/lash.g4` you can use the `debug grammar` configuration. It will make use of the awesome Visual Studio Code Extension [ANTLR4 grammar syntax support](https://marketplace.visualstudio.com/items?itemName=mike-lischke.vscode-antlr4) and generate a visual representation of the parse tree for the file `language-showcase.lsh` in the project root. Unfortunately, the extension does not allow to dynamically be run on different files.

When making changes to the grammar use the `build all` configuration to run the ANTLR generator and compile the TypeScript sources. It will run the CLI the same way as `launch lash compiler` on the currently opened file in Visual Studio Code.

# Code Convention
In order to ensure a clean and standardized code base lash uses ESLint (with Airbnb style guide) and Prettier. Prettier is configured to be run as part of ESLint and therefore does not need to be run separately. To run the linter run `npm run lint` or `npm run lint-fix` to automatically fix what prettier can fix automatically. You do not need to run these commands when using Visual Studio Code which is configured to run `lint-fix` when you save a file.

# Running the tests

Lash uses `jest` to perform tests. The tests are placed into `test/` and currently contain only e2e tests in `test/e2e`. Use `npm run test` to perform all tests.


## e2e tests

The e2e tests are divided into two types of tests. The first type of tests searches for all `.lsh` files contained `test/e2e/valid_code/` and compiles it to bash. This output is compared to the contents of the corresponding `.sh` file (with the same filename). It expects the generated output to be equal to the defined output contained in the corresponding `.sh` file.

The second type of e2e tests searches for `.lsh` files in `test/e2e/invalid_code/`. These input files are invalid code i.e. being syntactically or semantically incorrect (e.g. duplicate variable declaration). It runs the lash compiler on those files and expects them to fail.

In order to run the tests run `npm run test`.